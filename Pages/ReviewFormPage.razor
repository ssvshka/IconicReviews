@page "/ReviewForm"
@page "/ReviewForm/{reviewId:int}"
@using CourseProject.Services
@using TinyMCE.Blazor
@inject ReviewService reviewService
@inject ViewService viewService
@inject UserService userService
@inject NavigationManager navigationManager

@if (review is null || review.Work is null || review.Work.Category is null)
{
    <text>Loading...</text>
}
else
{
    <AuthorizeView>
        <Authorized>
            <MudGrid>
                <MudItem xs="12" sm="7">
                    <MudPaper Class="pa-4">
                        <MudForm>
                            <MudSelect T="Category" Label="Category" Dense="true" Value="review.Work.Category" ValueChanged="SetCategory" 
                                            Variant="Variant.Outlined" Disabled="IsEditing()">
                                @foreach (var item in viewService.Categories!)
                                {
                                    <MudSelectItem Value="@item"/>
                                }
                            </MudSelect>
                            <MudTextField T="string" Label="Review Title" @bind-Value="review.Title" 
                                             Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true"></MudTextField>
                            <MudAutocomplete T="string" Label="Work" Dense="true" @bind-Value="workTitle" SearchFunc="@SearchWorks"
                                             Variant="Variant.Outlined" OnBlur="SetWorkData" CoerceValue="true"/>
                            <MudAutocomplete T="string" Label="Tags" OnAdornmentClick="AddTag" @bind-Value="tagTitle" SearchFunc="@SearchTags"
                                             Variant="Variant.Outlined" AdornmentIcon="@Icons.Material.Filled.PlusOne" CoerceValue="true" />
                            <MudItem xs="12" md="12">
                                <MudText Class="mb-n3" Typo="Typo.body2">
                                    Selected tags: 
                                    @foreach (var t in viewService.ReviewTags!)
                                    {
                                        <MudChip Text="@(GetTagTitle(t.TagId))" OnClose="RemoveTag"></MudChip>
                                    }
                                </MudText>
                            </MudItem>
                            <br /> <br /> <br />
                            <Editor @bind-Value="review.Text" />
                            <UploadBlobsComponent @bind-ImageUrl="review.ImageUrl"/>
                            <MudRating @bind-SelectedValue="review.Rating" MaxValue="10" />
                            <MudButton OnClick="PublishReviewAndRedirectToHome" @onkeydown="@Enter" Variant="Variant.Filled">Publish</MudButton>
                        </MudForm>   
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </Authorized>
        <NotAuthorized>
            You have to log in to write a review.
        </NotAuthorized>
    </AuthorizeView>
}

@code {
    const string DEFAULT_IMAGE = "https://placehold.co/600x400/EEE/31343C?font=lora&text=Oops...+Image+is+missing";

    [Parameter]
    public int ReviewId { get; set; }
    private Review review = new();
    private string workTitle = "";
    private string tagTitle = default!;

    protected override async Task OnInitializedAsync()
    {
        await viewService.GetCategoriesAsync();
        if (ReviewId != 0)
        {
            review = await reviewService.GetReviewByIdAsync(ReviewId);
            workTitle = review.Work.Title;
        }
        else
        {
            review.Work = new Work();
            review.Work.Category = new Category();
        }
        await viewService.GetCurrentReviewTagsAsync(ReviewId);
    }

    private async Task PublishReviewAndRedirectToHome()
    {
        await SetReviewData();
        if (ReviewId == 0)
            await reviewService.AddReview(review);
        else await reviewService.EditReview(review);
        await reviewService.CalculateAuthorRating(review.Work.Title);
        navigationManager.NavigateTo("/");
    }

    private async Task SetReviewData()
    {
        await SetWorkData();
        if (ReviewId == 0)
            review.PostedOn = DateTime.Now;
        else
            review.EditedOn = DateTime.Now;
        review.UserId = await userService.GetCurrentUserId();
        if (review.ImageUrl is null)
            review.ImageUrl = DEFAULT_IMAGE;
    }

    public void SetCategory(Category value)
    {
        review.Work.Category = value;
    }

    private async Task SetWorkData()
    {
        //review.Work = await reviewService.GetWorkByTitle(workTitle);
        if (!await reviewService.FindWorkByTitle(review.Work.Title))
        {
            //review.Work.CategoryId = review.Work.Category.Id;
            await reviewService.AddWork(review.Work);
        }
        else review.Work = await reviewService.GetWorkByTitle(review.Work.Title);
    }

    private async Task AddTag()
    {
        Tag t;
        if (tagTitle is not null)
        {
            if (!await reviewService.FindTagByTitle(tagTitle))
            {
                t = new Tag { Title = tagTitle };
                await reviewService.AddTag(t);
            }
            else 
            {
                t = await reviewService.GetTagByTitle(tagTitle);
            }
            await viewService.AddTagToReview(new ReviewTag
                {
                    TagId = t.Id,
                    ReviewId = ReviewId
                });
            tagTitle = "";
        }
    }

    private async Task RemoveTag(MudChip chip)
    {
        await viewService.RemoveTagFromReviewAsync(review.Id, chip.Text);
    }

    private string GetTagTitle(int tagId)
    {
        var t = reviewService.GetTagById(tagId);
        return t.Title;
    }

    private bool IsEditing()
        => ReviewId != 0;

    private async Task<IEnumerable<string>> SearchTags(string value)
    {
        await viewService.GetTagsAsync();
        if (string.IsNullOrEmpty(value))
            return viewService.Tags!
                .Select(x => x.Title);
        return viewService.Tags!
            .Where(x => x.Title.Contains(value, StringComparison.InvariantCultureIgnoreCase))
            .Select(x => x.Title);
    }

    private async Task<IEnumerable<string>> SearchWorks(string value)
    {
        await viewService.GetWorksByCategoryAsync(review.Work.Category);
        if (string.IsNullOrEmpty(value))
            return viewService.Works!
                .Select(x => x.Title);
        return viewService.Works!
            .Where(x => x.Title.Contains(value, StringComparison.InvariantCultureIgnoreCase))
            .Select(x => x.Title);
    }

    private async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
            await PublishReviewAndRedirectToHome();
    }
}
